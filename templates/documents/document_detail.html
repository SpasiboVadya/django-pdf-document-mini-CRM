{% extends 'base.html' %}

{% block title %} {{ document.number }} | {{ block.super }}{% endblock %}

{% block full_width_content %}
<div class="flex h-screen">
    <!-- Sidebar - full height, fixed width -->
    <div class="w-80 shrink-0 bg-gray-900">
        {% include 'documents/sidebar.html' %}
    </div>
    
    <!-- Main content -->
    <div class="flex-grow p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <a href="{% url 'documents:document_list' %}" class="flex items-center text-blue-600 hover:text-blue-800">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Повернутись до списку
            </a>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
            </div>
            
            <div class="p-4">
                {% if pages %}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {% for page in pages %}
                            <div class="bg-white border border-gray-200 rounded-md overflow-hidden shadow-sm">
                                <div class="aspect-w-16 aspect-h-9 relative bg-gray-100">
                                    {% if page.file_path %}
                                        {% with file_ext=page.file_path.name|lower %}
                                            {% if '.pdf' in file_ext %}
                                                <!-- PDF Preview -->
                                                <div class="w-full h-80">
                                                    <iframe src="{{ page.file_path.url }}" width="100%" height="100%" class="border-0"></iframe>
                                                </div>
                                            {% elif '.jpg' in file_ext or '.jpeg' in file_ext or '.png' in file_ext or '.gif' in file_ext %}
                                                <!-- Image Preview -->
                                                <img src="{{ page.file_path.url }}" alt="{{ page.page_name }}" class="object-contain w-full h-80">
                                            {% else %}
                                                <!-- No Preview Available -->
                                                <div class="w-full h-80 flex items-center justify-center">
                                                    <span class="text-gray-400">Передперегляд недоступний</span>
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                        
                                        <!-- Action buttons -->
                                        <div class="absolute top-2 right-2 flex space-x-1">
                                            <a href="{{ page.file_path.url }}" target="_blank" class="p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                            </a>
                                            <a href="{{ page.file_path.url }}" download class="p-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                            </a>
                                        </div>
                                    {% else %}
                                        <div class="w-full h-80 flex items-center justify-center">
                                            <span class="text-gray-400">Немає файлу</span>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="p-4">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-sm font-medium text-gray-900">{{ page.page_name }}</h3>
                                        {% if page.discrepancy_found %}
                                            <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">
                                                Виявлено розбіжності
                                            </span>
                                        {% else %}
                                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                                                Без розбіжностей
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="mt-2 flex justify-between text-xs text-gray-500">
                                        <span>{{ page.created_at|date:"d.m.Y" }}</span>
                                        <span>{{ page.created_at|date:"H:i" }}</span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="py-8 text-center text-gray-500">
                        Для цього документа ще не додано сторінок.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const updateStatusBtn = document.getElementById('update-status-btn');
        if (updateStatusBtn) {
            updateStatusBtn.addEventListener('click', function() {
                const documentId = this.getAttribute('data-document-id');
                const newStatus = document.getElementById('new-status').value;
                
                // AJAX request to update status
                fetch(`/documents/${documentId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `status=${newStatus}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show updated status
                        window.location.reload();
                    } else {
                        alert('Помилка при оновленні статусу. Спробуйте ще раз.');
                    }
                })
                .catch(error => {
                    console.error('Помилка:', error);
                    alert('Виникла помилка при оновленні статусу.');
                });
            });
        }
        
        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %} 